name: Upload GDrive
description: "upload file into GDrive"

inputs:
  env_url:
    description: "Protected JSON URL"
    required: true
  env_token:
    description: "Bearer or token for the protected JSON"
    required: true
  file_path:
    description: "Filepath of the file that you want to upload"
    required: true

outputs:
  file_id:
    description: "Drive file ID after upload"
    value: ${{ steps.rclone_copy.outputs.file_id }}
  filename:
    description: "Basename of uploaded file"
    value: ${{ steps.rclone_copy.outputs.filename }}
  query:
    description: "Filename without extension"
    value: ${{ steps.rclone_copy.outputs.query }}
  imdb:
    description: "IMDb id prefix"
    value: ${{ steps.rclone_copy.outputs.imdb }}

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Load Remote ENV from Protected JSON
      uses: subekti404dev/gha-json-env@v1
      with:
        url: ${{ inputs.env_url }}
        token: ${{ inputs.env_token }}

    # GETTER (fills B64_RCLONE into $GITHUB_ENV)
    - name: Fetch rclone config (base64)
      shell: sh
      run: |
        b64_rclone=$(curl -fsSL "${{ env.rclone_getter_url }}")
        if [ -z "$b64_rclone" ]; then
          echo "::error::Failed to fetch rclone config or config is empty."
          exit 1
        fi
        echo "::add-mask::$b64_rclone"
        echo "B64_RCLONE<<EOF" >> $GITHUB_ENV
        echo "$b64_rclone" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "rclone getter: stored B64_RCLONE to GITHUB_ENV (masked)."

    - name: Setup Rclone Config
      shell: sh
      env:
        rclone_config: ${{ env.B64_RCLONE }}
      run: |
        rclone_conf_path=$(rclone config file | grep 'rclone.conf' | cut -d' ' -f6)
        echo "$rclone_config" | base64 -d > "$rclone_conf_path"

    - name: Rclone copy by IMDb folder
      id: rclone_copy
      shell: sh
      env:
        video_file_path: ${{ inputs.file_path }}
        dest_remote: gdrive1
        dest_root: GHA
      run: |
        set -eu

        # Derive variables
        filename=$(basename "$video_file_path")
        query="${filename%.*}"        # filename without extension
        imdb="${query%%:*}"           # take part before first colon

        echo "filename: $filename"
        echo "query:    $query"
        echo "imdb:     $imdb"

        # Ensure destination folder exists (safe if it already exists)
        rclone mkdir "${dest_remote}:${dest_root}/${imdb}"

        # Upload exact path
        rclone copy \
          "$video_file_path" \
          "${dest_remote}:${dest_root}/${imdb}"

        # Obtain Drive file ID by searching for the file in the destination directory.
        # This is more robust than assuming a fixed path.
        json_output=$(rclone lsjson -R "${dest_remote}:${dest_root}/${imdb}" | grep -F "\"Name\":\"${filename}\"" || echo "")

        if [ -z "$json_output" ]; then
          echo "::error::Failed to find file '${filename}' in remote '${dest_remote}:${dest_root}/${imdb}' after upload."
          rclone ls -R "${dest_remote}:${dest_root}/${imdb}"
          exit 1
        fi

        if command -v jq >/dev/null 2>&1; then
          file_id=$(echo "$json_output" | jq -r '.ID')
        else
          # Basic fallback parser if jq is unavailable
          file_id=$(echo "$json_output" | sed -n 's/.*"ID":"\([^"]*\)".*/\1/p')
        fi

        if [ -z "${file_id:-}" ]; then
          echo "Failed to determine file_id for ${filename}" >&2
          echo "lsjson output was: $json" >&2
          exit 1
        fi

        # Export outputs
        {
          echo "filename=$filename"
          echo "query=$query"
          echo "imdb=$imdb"
          echo "file_id=$file_id"
        } >> "$GITHUB_OUTPUT"

    # SETTER (reads ~/.config/rclone/rclone.conf and POSTs it)
    - name: Send rclone.conf (POST, masked)
      shell: sh
      run: |
        rclone_conf_path=$(rclone config file | grep 'rclone.conf' | cut -d' ' -f6)
        if [ ! -f "$rclone_conf_path" ]; then
          echo "::error::rclone config file not found at '$rclone_conf_path'"
          exit 1
        fi
        b64_config=$(base64 -w 0 "$rclone_conf_path")
        echo "::add-mask::$b64_config"
        setter_url="${{ env.rclone_setter_url }}"
        # Append data as a query parameter
        if [[ "$setter_url" == *"?"* ]]; then
          final_url="${setter_url}&data=${b64_config}"
        else
          final_url="${setter_url}?data=${b64_config}"
        fi
        curl -fsSL -X GET "$final_url"
        echo "rclone setter: POSTed base64 config successfully."
